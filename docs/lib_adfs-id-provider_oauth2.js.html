<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/adfs-id-provider/oauth2.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-idprovider.html">idprovider</a><ul class='methods'><li data-type='method'><a href="module-idprovider.html#.get">get</a></li><li data-type='method'><a href="module-idprovider.html#.handle401">handle401</a></li><li data-type='method'><a href="module-idprovider.html#.login">login</a></li><li data-type='method'><a href="module-idprovider.html#.logout">logout</a></li><li data-type='method'><a href="module-idprovider.html#.post">post</a></li></ul></li><li><a href="module-lib_adfs-id-provider.html">lib/adfs-id-provider</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider.html#.handleIdProviderRequest">handleIdProviderRequest</a></li></ul></li><li><a href="module-lib_adfs-id-provider_array.html">lib/adfs-id-provider/array</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_array.html#.inFirstButNotInSecond">inFirstButNotInSecond</a></li></ul></li><li><a href="module-lib_adfs-id-provider_auth.html">lib/adfs-id-provider/auth</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_auth.html#.handleLogoutRequest">handleLogoutRequest</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth.html#~getRedirectAfterLogoutUrl">getRedirectAfterLogoutUrl</a></li></ul></li><li><a href="module-lib_adfs-id-provider_auth_group.html">lib/adfs-id-provider/auth/group</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_auth_group.html#.createAndUpdateGroupsFromJwt">createAndUpdateGroupsFromJwt</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_group.html#~addUser">addUser</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_group.html#~createOrModify">createOrModify</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_group.html#~removeUser">removeUser</a></li></ul></li><li><a href="module-lib_adfs-id-provider_auth_sanitizeName.html">lib/adfs-id-provider/auth/sanitizeName</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_auth_sanitizeName.html#.sanitizeName">sanitizeName</a></li></ul></li><li><a href="module-lib_adfs-id-provider_auth_user.html">lib/adfs-id-provider/auth/user</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#.createOrUpdateFromJwt">createOrUpdateFromJwt</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#.getGroupKeys">getGroupKeys</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#.getGroups">getGroups</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#.getProfile">getProfile</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#.getRoles">getRoles</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#~createOrModify">createOrModify</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#~enrichProfileFromJwt">enrichProfileFromJwt</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#~modifyProfile">modifyProfile</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_auth_user.html#~setPathToValue">setPathToValue</a></li></ul></li><li><a href="module-lib_adfs-id-provider_context.html">lib/adfs-id-provider/context</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_context.html#.runAsAdmin">runAsAdmin</a></li></ul></li><li><a href="module-lib_adfs-id-provider_jwt.html">lib/adfs-id-provider/jwt</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_jwt.html#.fromAccessToken">fromAccessToken</a></li></ul></li><li><a href="module-lib_adfs-id-provider_oauth2.html">lib/adfs-id-provider/oauth2</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_oauth2.html#.redirectToAuthorizationUrl">redirectToAuthorizationUrl</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_oauth2.html#.requestAccessToken">requestAccessToken</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_oauth2.html#~getRedirectUri">getRedirectUri</a></li></ul></li><li><a href="module-lib_adfs-id-provider_object.html">lib/adfs-id-provider/object</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_object.html#.valueFromFormat">valueFromFormat</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_object.html#~isNotSet">isNotSet</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_object.html#~isSet">isSet</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_object.html#~toStr">toStr</a></li></ul></li><li><a href="module-lib_adfs-id-provider_portal.html">lib/adfs-id-provider/portal</a><ul class='methods'><li data-type='method'><a href="module-lib_adfs-id-provider_portal.html#.getReturnToUrl">getReturnToUrl</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_portal.html#~getAbsoluteSiteUrl">getAbsoluteSiteUrl</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_portal.html#~getAbsoluteUrlFromPath">getAbsoluteUrlFromPath</a></li><li data-type='method'><a href="module-lib_adfs-id-provider_portal.html#~isAbsoluteUrl">isAbsoluteUrl</a></li></ul></li><li><a href="module-site_filters_isAccessTokenExpired.html">site/filters/isAccessTokenExpired</a><ul class='methods'><li data-type='method'><a href="module-site_filters_isAccessTokenExpired.html#.responseFilter">responseFilter</a></li></ul></li><li><a href="module-site_parts_authentication.html">site/parts/authentication</a><ul class='methods'><li data-type='method'><a href="module-site_parts_authentication.html#.get">get</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/adfs-id-provider/oauth2.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * oauth2 module.
 * @module lib/adfs-id-provider/oauth2
 */

//──────────────────────────────────────────────────────────────────────────────
// Require libs
//──────────────────────────────────────────────────────────────────────────────
var lib = {
	adfsIdProvider: {
		object: require('/lib/adfs-id-provider/object'),
		portal: require('/lib/adfs-id-provider/portal')
	},
	node: {
		uriJs: require('/lib/urijs/src/URI')
	},
	xp: {
		auth:       require('/lib/xp/auth'),
		httpClient: require('/lib/xp/http-client'),
		portal:     require('/lib/xp/portal')
	}
};

//──────────────────────────────────────────────────────────────────────────────
// Alias functions from libs
//──────────────────────────────────────────────────────────────────────────────
var toStr               = lib.adfsIdProvider.object.toStr;
var valueFromFormat     = lib.adfsIdProvider.object.valueFromFormat;
var getReturnToUrl      = lib.adfsIdProvider.portal.getReturnToUrl;
var getIdProviderConfig = lib.xp.auth.getIdProviderConfig;
var sendRequest         = lib.xp.httpClient.request;
var getUserStoreKey     = lib.xp.portal.getUserStoreKey;
var getIdProviderUrl    = lib.xp.portal.idProviderUrl;

//──────────────────────────────────────────────────────────────────────────────
// Oauth2 methods
//──────────────────────────────────────────────────────────────────────────────

/**
 * Get the redirectUri by combining idProviderConfig and request.
 * @param {Object} params
 * @param {request} params.request
 * @param {Object} [params.idProviderConfig=getIdProviderConfig()]
 * @returns {lib.node.uriJs} redirectUri
 */
function getRedirectUri(params) {
	if(!params.idProviderConfig) { params.idProviderConfig = getIdProviderConfig(); }
	log.debug('getRedirectUri(' + toStr(params) + ')');

	var userStoreKey = getUserStoreKey();
	log.debug('userStoreKey:' + toStr(userStoreKey));

	var format = params.idProviderConfig.redirectUrl || '/_/idprovider/${userStoreKey}';
	log.debug('format:' + toStr(format));

	var redirectUri = new lib.node.uriJs(valueFromFormat({
		format: format,
		data: { userStoreKey: userStoreKey }
	}), params.request.scheme + '://' + params.request.host + (params.request.port ? ':' + params.request.port : ''));

	log.debug('getRedirectUri(' + toStr(params) + ') --> ' + toStr(redirectUri));
	return redirectUri;
};
exports.getRedirectUri = getRedirectUri;


/**
 * Redirect the browser to the SSO login page so the user can login.
 * @param {request} request
 * @returns {httpTemporaryRedirectResponse}
 */
exports.redirectToAuthorizationUrl = function(request) {
	log.debug('redirectToAuthorizationUrl(' + toStr(request) + ')');

	var idProviderConfig = getIdProviderConfig();
	log.debug('idProviderConfig:' + toStr(idProviderConfig));

	var resource = request.scheme + '://' + request.host + (request.port ? ':' + request.port : '');
	var returnToUrl = getReturnToUrl(request);
	var location = new lib.node.uriJs(idProviderConfig.authorizationUrl);
	location.addQuery('response_type', 'code');
	location.addQuery('client_id', idProviderConfig.clientId);
	location.addQuery('resource', resource);
	location.addQuery('redirect_uri', getRedirectUri({
		request:          request,
		idProviderConfig: idProviderConfig
	}).toString());
	var response = {
		body: '', // NOTE: Workaround for Safari so Content-Length header becomes 0 on /admin/tool
		status: 307, // Temporary redirect // http://insanecoding.blogspot.no/2014/02/http-308-incompetence-expected.html
		headers: {
			'Location': location.toString(),
			//Referer: returnToUrl, // AD FS doesn't use this. We use a cookie instead.
		},
		cookies: {
			enonicXpReturnToUrl: {
				value: returnToUrl, // So idProviderRequestHandler knows which url to redirect the user to
				path: '/'
			}
		},
		postProcess: false,
		applyFilters: false
	};
	log.debug('redirectToAuthorizationUrl() response:' + toStr(response));
	return response;
}; // function redirectToAuthorizationUrl


/**
 * Ask the authentication provider directly (server to server) for an access token, using request.params.code and clientId.
 * @param {request} request
 * @returns {accessTokenResponse}
 */
exports.requestAccessToken = function(request) {
	log.debug('requestAccessToken(' + toStr(arguments) + ')');

	var idProviderConfig = getIdProviderConfig();
	log.debug('idProviderConfig:' + toStr(idProviderConfig));

	var idProviderUrl = getIdProviderUrl({}); // /_/idprovider/adfs
	log.debug('idProviderUrl:' + toStr(idProviderUrl));

	var accessTokenRequest = {
		method: 'POST',
		url: idProviderConfig.tokenUrl,
		headers: {
			Accept: 'appication/json'
		},
		params: {
			grant_type: 'authorization_code',
			client_id: idProviderConfig.clientId,
			redirect_uri: request.scheme + '://' + request.host + (request.port ? ':' + request.port : '') + idProviderUrl,
			code: request.params.code
		},
		proxy: idProviderConfig.proxy
	};
	log.debug('requestAccessToken: accessTokenRequest:' + toStr(accessTokenRequest));

	var accessTokenResponse = sendRequest(accessTokenRequest);
	log.debug('requestAccessToken: accessTokenResponse:' + toStr(accessTokenResponse));

	return accessTokenResponse;
	/* {
		"access_token":"thetoken", // JWT format
		"token_type":"bearer",
		"expires_in":3600
		// Because the Client did not authenticate itself with any client secret, no refresh token is issued
	}*/
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Apr 17 2018 09:39:28 GMT+0200 (CEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
